name: Daily AI Sleep Story Generator

on:
  schedule:
    - cron: "0 0 * * *" # Her gün UTC 00:00'da (Türkiye saatiyle 03:00)
  workflow_dispatch: # Manuel tetikleme

jobs:
  generate-story:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Push izni için

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests

      - name: Generate AI Sleep Story
        env:
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        run: |
          python - <<'PY'
          import requests, json, datetime, os
          from pathlib import Path

          print("Requesting story from Hugging Face...")

          # MODEL ADINI BURADA DEĞİŞTİREBİLİRSİN
          model = "google/flan-t5-small"
          api_url = f"https://router.huggingface.co/hf-inference/models/{model}"

          prompt = """Write a short, relaxing bedtime story for adults about peace, stars, and gentle dreams. The story should be around 3 minutes long and help calm the mind."""

          headers = {"Authorization": f"Bearer {os.environ['HF_API_TOKEN']}"}

          response = requests.post(api_url, headers=headers, json={"inputs": prompt})

          if response.status_code != 200:
              print(f"❌ Error: {response.status_code} {response.text}")
              exit(1)

          try:
              data = response.json()
              if isinstance(data, list) and "generated_text" in data[0]:
                  story = data[0]["generated_text"]
              elif isinstance(data, dict) and "generated_text" in data:
                  story = data["generated_text"]
              else:
                  story = str(data)
          except Exception as e:
              print("❌ Failed to parse response:", e)
              print(response.text)
