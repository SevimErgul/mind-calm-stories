name: Daily AI Sleep Story Generator

on:
  schedule:
    - cron: "0 0 * * *" # Her gün UTC 00:00'da (Türkiye saatiyle 03:00)
  workflow_dispatch: # Manuel tetikleme

jobs:
  generate-story:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests

      - name: Generate AI Sleep Story
        env:
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        run: |
          python - <<'PY'
          import requests, json, datetime, os
          from pathlib import Path

          print("Requesting story from Hugging Face...")

          # ✅ Desteklenen model
          model = "mistralai/Mistral-7B-Instruct-v0.2"

          prompt = """Write a 3-minute calm bedtime story for adults about peace, stars, and a quiet night. 
          The story should be soothing, imaginative, and help the listener fall asleep peacefully."""

          api_url = f"https://router.huggingface.co/hf-inference/models/{model}"

          headers = {
              "Authorization": f"Bearer {os.environ['HF_API_TOKEN']}",
              "Content-Type": "application/json"
          }

          response = requests.post(api_url, headers=headers, json={"inputs": prompt})

          if response.status_code != 200:
              print(f"❌ Error: {response.status_code} {response.text}")
              exit(1)

          try:
              data = response.json()
              story = None
              if isinstance(data, list) and "generated_text" in data[0]:
                  story = data[0]["generated_text"]
              elif isinstance(data, dict) and "generated_text" in data:
                  story = data["generated_text"]
              else:
                  story = json.dumps(data, ensure_ascii=False)
          except Exception as e:
              print("❌ Failed to parse response:", e)
              print(response.text)
              exit(1)

          today = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          Path("stories").mkdir(exist_ok=True)
          file_path = f"stories/{today}.txt"

          with open(file_path, "w", encoding="utf-8") as f:
              f.write(story)

          print(f"✅ Story saved to {file_path}")
          PY

      - name: Commit and push story
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add stories/*.txt || echo "No files to add"
          git commit -m "Add daily AI story" || echo "No changes to commit"
          git push
